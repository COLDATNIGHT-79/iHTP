{% extends "base.html" %}

{% block title %}{{ post.title }} | iHateThisPerson{% endblock %}

{% block head %}
<!-- SEO Meta Tags -->
<meta name="description" content="{{ post.description or post.reason or 'Anonymous hate post' }}">
<meta name="robots" content="index, follow">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="article">
<meta property="og:url" content="{{ request.url }}">
<meta property="og:title" content="{{ post.title }} | iHateThisPerson">
<meta property="og:description" content="{{ post.description or post.reason or 'See why people hate this person' }}">
{% if post.image_url %}
<meta property="og:image" content="{{ post.image_url }}">
{% endif %}
<meta property="og:site_name" content="iHateThisPerson">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ post.title }} | iHateThisPerson">
<meta name="twitter:description" content="{{ post.description or post.reason or 'See why people hate this person' }}">
{% if post.image_url %}
<meta name="twitter:image" content="{{ post.image_url }}">
{% endif %}

<!-- html2canvas for PNG export -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
{% endblock %}

{% block content %}
<div class="demo-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <a href="/" style="color: #003d7a; text-decoration: none; font-size: 14px;">‚Üê Back to Board</a>
        <button id="export-btn" class="btn-submit" style="background-color: #003d7a;">
            üì∑ EXPORT AS PNG
        </button>
    </div>
</div>

<!-- Export Container (styled for PNG output) -->
<div id="export-container" class="demo-section">
    <div class="demo-post export-card" id="card-to-export">
        {% if post.status.value == 'blocked' %}
        <div class="warning-label">
            ‚ö† BLOCKED: {{ post.moderation_reason or "VIOLATES CONTENT POLICY" }}
        </div>
        {% endif %}

        <div class="demo-post-header" style="display: flex; justify-content: space-between;">
            <span>iHateThisPerson.com</span>
            <span>POST #{{ post.id | string | truncate(8, True, '') }}</span>
        </div>

        {% if post.image_url %}
        <div class="demo-post-image">
            <img src="{{ post.image_url }}" alt="{{ post.title }}" crossorigin="anonymous"
                onerror="this.parentElement.innerHTML='[IMAGE UNAVAILABLE]'">
        </div>
        {% else %}
        <div class="demo-post-image">[NO IMAGE]</div>
        {% endif %}

        <div class="demo-post-content">
            <h4 class="demo-post-title">{{ post.title }}</h4>

            {% if post.description %}
            <p style="font-size: 13px; margin-bottom: 10px;">{{ post.description }}</p>
            {% endif %}

            {% if post.reason %}
            <div class="reason-box">
                <strong>Reason:</strong> {{ post.reason }}
            </div>
            {% endif %}

            {% if post.tags %}
            <div class="demo-tags">
                {% for tag in post.tags %}
                <span class="demo-tag">{{ tag }}</span>
                {% endfor %}
            </div>
            {% endif %}

            <div
                style="border-top: 1px solid #999; padding-top: 15px; display: flex; justify-content: space-between; font-size: 11px; align-items: center;">
                <span>Posted: {{ post.created_at.strftime('%b %d, %Y') }}</span>
                <span class="hate-count" style="font-weight: bold;">‚òÜ {{ post.like_count }} likes</span>
            </div>
        </div>
    </div>
</div>

<!-- Share Section -->
<div class="demo-section">
    <h2>Share This Post</h2>
    <div class="post-form-box">
        <div class="form-group">
            <label>Direct Link</label>
            <input type="text" class="form-input full-width" value="{{ request.url }}" readonly onclick="this.select()">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <a href="https://twitter.com/intent/tweet?url={{ request.url | urlencode }}&text={{ post.title | urlencode }}"
                target="_blank" class="btn-submit" style="text-decoration: none; text-align: center;">
                Share on Twitter
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url | urlencode }}" target="_blank"
                class="btn-submit" style="background-color: #003d7a; text-decoration: none; text-align: center;">
                Share on Facebook
            </a>
        </div>
    </div>
</div>

<script>
    document.getElementById('export-btn').addEventListener('click', function () {
        const card = document.getElementById('card-to-export');
        const btn = this;

        btn.textContent = 'Generating...';
        btn.disabled = true;

        html2canvas(card, {
            backgroundColor: '#f5f1e8',
            scale: 2,
            useCORS: true,
            allowTaint: true,
            logging: false
        }).then(function (canvas) {
            const link = document.createElement('a');
            link.download = 'ihtp-{{ post.id | string | truncate(8, True, "") }}.png';
            link.href = canvas.toDataURL('image/png');
            link.click();

            btn.textContent = 'üì∑ EXPORT AS PNG';
            btn.disabled = false;
        }).catch(function (err) {
            console.error('Export failed:', err);
            btn.textContent = 'Export Failed - Try Again';
            btn.disabled = false;
        });
    });
</script>
{% endblock %}